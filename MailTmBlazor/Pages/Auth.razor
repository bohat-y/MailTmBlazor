@page "/auth"
@using System.Net
@inject MailTmBlazor.Application.Abstractions.IAuthService AuthService
@inject MailTmBlazor.Application.Abstractions.IMailboxService Mail
@inject MailTmBlazor.Infrastructure.Auth.IAccountSession Session
@inject NavigationManager Nav
@inject ILogger<Auth> Logger
@using System.ComponentModel.DataAnnotations

<h3>Sign in to Temporary Mail</h3>

@if (loading)
{
  <p>Loading domains…</p>
}
else if (error is not null)
{
  <p class="text-danger">@error</p>
}
else
{
  <EditForm EditContext="editContext" OnValidSubmit="RegisterThenLoginAsync">
    <DataAnnotationsValidator />
    <div class="mb-2">
      <label for="auth-username">Username</label>
      <input id="auth-username"
             class="form-control"
             value="@form.Username"
             @oninput="OnUsernameInput" />
      <ValidationMessage For="() => form.Username" />
      <small class="text-muted">We’ll append the domain.</small>
    </div>

    <div class="mb-2">
      <label for="auth-password">Password</label>
      <input id="auth-password"
             class="form-control"
             type="password"
             value="@form.Password"
             @oninput="OnPasswordInput" />
      <ValidationMessage For="() => form.Password" />
    </div>

    <div class="mb-3">
      <label>Domain</label>
      @if (domains?.Count == 1)
      {
        <small class="form-control-plaintext text-muted">@domains[0].Domain</small>
        <input type="hidden" value="@domains[0].Domain" />
      }
      else
      {
        <InputSelect @bind-Value="selectedDomain" class="form-select">
          @foreach (var d in domains!)
          {
            <option value="@d.Domain">@d.Domain</option>
          }
        </InputSelect>
      }
    </div>

    <div class="mb-3">
      <strong>Email preview:</strong> @ComposedAddress
    </div>

    <button type="submit" class="btn btn-primary" disabled="@submitting">
      @(submitting ? "Signing in…" : "Register & Sign in")
    </button>

    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
      <p class="text-danger mt-2">@errorMessage</p>
    }
  </EditForm>
}

@code {
  List<MailTmBlazor.Domain.Entities.DomainName>? domains;
  string? selectedDomain;
  private readonly AuthFormModel form = new();
  private EditContext editContext = default!;
  bool loading = true;
  bool submitting = false;
  string? error;
  string? errorMessage;
  private bool didRedirect;

  protected override void OnInitialized()
  {
    editContext = new EditContext(form);
  }

  string ComposedAddress => string.IsNullOrWhiteSpace(form.Username) || string.IsNullOrWhiteSpace(selectedDomain)
    ? "(enter username)"
    : $"{form.Username}@{selectedDomain}";

  protected override async Task OnInitializedAsync()
  {
    try
    {
      domains = (await Mail.GetDomainsAsync()).ToList();
      selectedDomain ??= domains.FirstOrDefault()?.Domain;
    }
    catch (Exception ex)
    {
      error = ex.Message;
    }
    finally
    {
      loading = false;
    }
  }

  private async Task RegisterThenLoginAsync()
  {
    errorMessage = null;
    if (string.IsNullOrWhiteSpace(selectedDomain))
    {
      errorMessage = "No domain available.";
      return;
    }

    if (!editContext.Validate())
    {
      return;
    }

    var address = $"{form.Username}@{selectedDomain}";
    submitting = true;
    try
    {
      // 1) Try to create an account (ignore 409 if already exists)
      _ = await AuthService.RegisterAsync(address, form.Password);

      // 2) Login (this will fetch /me and store token+account in localStorage["account"])
      await AuthService.LoginAsync(address, form.Password);

      // 3) Navigate to profile
      Nav.NavigateTo("/me", forceLoad: true);
    }
    catch (MailTmApiException apiEx)
    {
      Logger.LogWarning(apiEx, "Auth flow failed for {Address} with {Status}", address, apiEx.StatusCode);
      errorMessage = apiEx.StatusCode switch
      {
        HttpStatusCode.UnprocessableEntity => "That alias is invalid or already exists.",
        HttpStatusCode.TooManyRequests => "Too many requests - please wait a moment and retry.",
        HttpStatusCode.BadRequest => "The request was rejected. Double-check your input and try again.",
        HttpStatusCode.Unauthorized => "Invalid email or password.",
        _ => apiEx.Message
      };
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Unexpected auth failure for {Address}", address);
      errorMessage = ex.Message;
    }
    finally
    {
      submitting = false;
    }
  }

  private void OnUsernameInput(ChangeEventArgs args)
  {
    form.Username = args.Value?.ToString() ?? string.Empty;
    NotifyFieldChanged(nameof(AuthFormModel.Username));
  }

  private void OnPasswordInput(ChangeEventArgs args)
  {
    form.Password = args.Value?.ToString() ?? string.Empty;
    NotifyFieldChanged(nameof(AuthFormModel.Password));
  }

  private void NotifyFieldChanged(string fieldName)
  {
    var fieldIdentifier = new FieldIdentifier(form, fieldName);
    editContext.NotifyFieldChanged(fieldIdentifier);
  }

}
