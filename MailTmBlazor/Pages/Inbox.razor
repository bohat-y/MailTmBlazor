@page "/inbox"
@inject MailTmBlazor.Application.Abstractions.IMailboxService Mail
@inject MailTmBlazor.Infrastructure.Auth.IAccountSession Session
@inject MailTmBlazor.Infrastructure.Realtime.InboxRealtimeClient Realtime
@inject NavigationManager Nav
@inject MailTmBlazor.Infrastructure.MailTm.MailTmEndpoints Endpoints
@inject MailTmBlazor.Application.Abstractions.IAuthService Auth
@inject IJSRuntime JS
@implements IAsyncDisposable

@if (loading) { <p>Loading…</p> }
else if (!string.IsNullOrEmpty(error)) { <p class="text-danger">@error</p> }
else
{
  @if (!items.Any()) { <p class="text-muted small">No messages.</p> }
  else
  {
    <ul class="list-group message-list">
      @foreach (var m in items)
      {
        <li class="list-group-item message-row" @onclick="() => OpenMessage(m.Id)">
          <div class="msg-left">
            <div class="avatar-circle">@GetInitial(m.FromAddress)</div>
            <div class="msg-meta">
              <div class="msg-from text-muted">@m.FromAddress</div>
              <div class="msg-subject">@m.Subject</div>
              <div class="msg-intro text-muted small">@m.Intro</div>
            </div>
          </div>
          <div class="msg-right">
            <div class="msg-date text-muted small">@m.CreatedAt.ToLocalTime().ToString("g")</div>
            @if (!m.Seen) { <span class="badge bg-primary">new</span> }
          </div>
        </li>
      }
    </ul>
  }

  <div class="inbox-footer">
    <div class="footer-actions">
        <button class="btn btn-sm btn-secondary me-2" @onclick="Refresh">Refresh</button>
        <button class="btn btn-sm btn-outline-primary" @onclick="TriggerEvent" disabled="@(!items.Any())">Trigger event</button>
    </div>
    <span class="muted small">Mercure: @status @if (lastEventAt is not null) { <span>• Last event: @lastEventAt?.ToLocalTime()</span> }</span>
  </div>
}

@if (showMessageModal)
{
    <div class="modal-backdrop" @onclick="CloseMessageModal">
        <div class="modal-shell message-modal" @onclick:stopPropagation="true">
            @if (messageLoading)
            {
                <p class="muted">Loading message…</p>
            }
            else if (!string.IsNullOrEmpty(messageError))
            {
                <p class="text-danger small">@messageError</p>
            }
            else if (selectedMessage is not null)
            {
                <div class="msg-header">
                    <h4>@selectedMessage.Subject</h4>
                    <div class="text-muted small">From @selectedMessage.FromAddress · @selectedMessage.CreatedAt.ToLocalTime().ToString("f")</div>
                </div>
                <div class="msg-body">
                    @if (showRawFrame && !string.IsNullOrWhiteSpace(rawHtmlContent))
                    {
                        <iframe class="msg-iframe"
                                sandbox="allow-same-origin"
                                srcdoc="@rawHtmlContent">
                        </iframe>
                    }
                    else if (!string.IsNullOrWhiteSpace(selectedMessage.Text))
                    {
                        <pre class="msg-text">@selectedMessage.Text</pre>
                    }
                    else if (selectedMessage.Html is not null && selectedMessage.Html.Any())
                    {
                        <div class="msg-html" @onclick:stopPropagation="true">
                            @((MarkupString)SanitizeHtml(selectedMessage.Html.First()))
                        </div>
                        <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="OpenRawHtml">Open raw HTML (sandboxed)</button>
                    }
                    else
                    {
                        <p class="muted">No content available.</p>
                    }
                </div>
            }
            <div class="modal-actions">
                <button class="btn btn-outline-secondary" @onclick="CloseMessageModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
  private List<MailTmBlazor.Domain.Entities.Message> items = new();
  private string status = "disconnected";
  private DateTimeOffset? lastEventAt;
  private bool loading = true;
  private string? error;
  private bool showMessageModal;
  private bool messageLoading;
  private string? messageError;
  private MailTmBlazor.Domain.Entities.Message? selectedMessage;
  private string? rawHtmlContent;
  private bool showRawFrame;
  protected override async Task OnInitializedAsync()
  {
    var snap = await Session.GetAsync() ?? await WaitForSessionAsync();
    if (snap is null)
    {
      Nav.NavigateTo("/auth", true);
      return;
    }

    await LoadInbox(showSpinner: true);

    status = "connecting…";

    var realtimeBase = Endpoints.ProxyBaseUrl;

    try
    {
      await Realtime.StartAsync(
        realtimeBase,
        snap.Id,
        snap.Token,
        async () =>
        {
          status = "connected";
          lastEventAt = DateTimeOffset.Now;
          await LoadInbox();
          await InvokeAsync(StateHasChanged);
        });
      status = "connected";
    }
    catch (HttpRequestException ex)
    {
      status = "rate-limited";
      error = $"Realtime unavailable: {ex.Message}";
    }
    catch (Exception ex)
    {
      status = "error";
      error = $"Realtime failed: {ex.Message}";
    }
  }

  private async Task LoadInbox(bool showSpinner = false)
  {
    if (showSpinner)
    {
      loading = true;
      await InvokeAsync(StateHasChanged);
    }

    try
    {
      error = null;
      var res = await Mail.GetMessagesAsync(1);
      items = res.Items.ToList();
    }
    catch (Exception ex)
    {
      error = ex.Message;
      status = "error";
    }
    finally
    {
      loading = false;
      await InvokeAsync(StateHasChanged);
    }
  }

  private async Task Refresh() => await LoadInbox(showSpinner: true);

  private async Task TriggerEvent()
  {
    // toggles seen on the first message -> hub publishes -> status timestamp updates
    var first = items.FirstOrDefault();
    if (first is null) return;
    await Mail.MarkSeenAsync(first.Id, seen: !first.Seen);
    await LoadInbox();
  }

  private async Task MarkRead(string id)
  {
    await Mail.MarkSeenAsync(id, true);
    await LoadInbox();
  }

  private async Task DeleteMessage(string id)
  {
    await Mail.DeleteAsync(id);
    await LoadInbox();
  }

  public async ValueTask DisposeAsync() => await Realtime.DisposeAsync();

  private async Task OpenMessage(string id)
  {
    showMessageModal = true;
    messageLoading = true;
    messageError = null;
    selectedMessage = null;
    try
    {
      selectedMessage = await Mail.GetMessageAsync(id);
    }
    catch (Exception ex)
    {
      messageError = ex.Message;
    }
    finally
    {
      messageLoading = false;
      await InvokeAsync(StateHasChanged);
    }
  }

  private void CloseMessageModal()
  {
    showMessageModal = false;
    messageLoading = false;
    messageError = null;
    selectedMessage = null;
    rawHtmlContent = null;
    showRawFrame = false;
  }

  private static string GetInitial(string fromAddress)
  {
    if (string.IsNullOrWhiteSpace(fromAddress)) return "?";
    var first = fromAddress.Trim()[0];
    return char.ToUpperInvariant(first).ToString();
  }

  private async Task<MailTmBlazor.Infrastructure.Auth.AccountSnapshot?> WaitForSessionAsync()
  {
    for (var i = 0; i < 15; i++)
    {
      var snap = await Session.GetAsync();
      if (snap is not null) return snap;
      await Task.Delay(200);
    }
    return null;
  }

  private string SanitizeHtml(string html)
  {
    // Lightweight scrub: strip script/style/iframe/object/embed/form and inline event handlers.
    string StripTag(string input, string tag) =>
      System.Text.RegularExpressions.Regex.Replace(input, $"<\\s*{tag}[^>]*?>[\\s\\S]*?<\\/{tag}\\s*>", string.Empty, System.Text.RegularExpressions.RegexOptions.IgnoreCase);

    var safe = html;
    foreach (var tag in new[] { "script", "style", "iframe", "object", "embed", "form" })
    {
      safe = StripTag(safe, tag);
    }

    // Strip on* event handlers
    safe = System.Text.RegularExpressions.Regex.Replace(safe, "on\\w+\\s*=\\s*\"[^\"]*\"", string.Empty, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    safe = System.Text.RegularExpressions.Regex.Replace(safe, "on\\w+\\s*=\\s*'[^']*'", string.Empty, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    safe = System.Text.RegularExpressions.Regex.Replace(safe, "on\\w+\\s*=\\s*[^\\s>]+", string.Empty, System.Text.RegularExpressions.RegexOptions.IgnoreCase);

    return $"<div class=\"msg-html-safe\">{safe}</div>";
  }

  private void OpenRawHtml()
  {
    if (selectedMessage?.Html is null || !selectedMessage.Html.Any()) return;
    rawHtmlContent = selectedMessage.Html.First();
    showRawFrame = true;
  }
}
